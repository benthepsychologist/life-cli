aip_id: AIP-life-cli-2025-12-11-pipeline-verbs
title: Add life pipeline Verbs (lorchestra-first)
spec_ref: .specwright/specs/cockpit-scripts-to-verbs.md
tier: C
status: in_progress
created: 2025-12-11T00:00:00+00:00

objective:
  goal: Add thin CLI verbs that invoke lorchestra composite jobs for daily pipeline operations
  acceptance_criteria:
    - "`life pipeline ingest` calls `lorchestra run pipeline.ingest`"
    - "`life pipeline canonize` calls `lorchestra run pipeline.canonize`"
    - "`life pipeline formation` calls `lorchestra run pipeline.formation`"
    - "`life pipeline project [--full-refresh]` calls `lorchestra run pipeline.project`"
    - "`life pipeline views` calls `lorchestra run pipeline.views`"
    - "`life pipeline run-all` calls `lorchestra run pipeline.daily_all`"
    - "`life --dry-run pipeline ingest` calls `lorchestra run pipeline.ingest --dry-run`"
    - "`life --verbose pipeline ingest` displays lorchestra stdout/stderr in real-time"
    - "`--full-refresh` clears `{vault_path}/views/*` only"
    - "After `project` command, print vault statistics"
    - "No job lists in life-cli code"
    - "No batching logic in life-cli code"
    - "Each verb makes exactly ONE lorchestra call"

context:
  constraints:
    - "life-cli must NOT know internal lorchestra job IDs (only composite job names)"
    - "life-cli must NOT implement batching or DAG logic"
    - "Subprocess adapter for lorchestra is acceptable (until Python API exists)"
  prerequisites:
    - "Lorchestra must have composite jobs defined (pipeline.ingest, pipeline.canonize, etc.)"

plan:
  - step_id: step-01
    description: "Create Processor Module"
    role: implementer
    gate_ref: "G0: Code Review"
    prompt: |
      Create `src/life_jobs/pipeline.py` with:

      1. `run_lorchestra(job_id, dry_run, verbose)` - Execute ONE lorchestra job
         - Command: `lorchestra run <job_id>` (append `--dry-run` if dry_run=True)
         - Returns result per schema: {job_id, success, exit_code, duration_ms, stdout, stderr, error_message}
         - Handles lorchestra not installed gracefully
         - Captures stdout/stderr

      2. `clear_views_directory(vault_path, dry_run)` - Delete `{vault_path}/views/*` only
         - Returns list of deleted paths
         - Respects dry-run (logs without deleting)

      3. `get_vault_statistics(vault_path)` - Count files in vault
         - Returns: {clients, sessions, transcripts, notes, summaries, reports}

      4. `__io__` metadata declaration

      ```python
      __io__ = {
          "reads": ["filesystem.vault"],
          "writes": ["filesystem.vault"],
          "external": ["lorchestra.subprocess"]
      }
      ```
    commands:
      - "python -c \"import sys; sys.path.insert(0, 'src'); from life_jobs import pipeline\""
    outputs:
      - "src/life_jobs/pipeline.py"

  - step_id: step-02
    description: "Create Job Definitions"
    role: implementer
    gate_ref: "G0: Code Review"
    prompt: |
      Create `src/life/jobs/pipeline.yaml` with one job per phase. Each job is a single `run_lorchestra` call.

      Jobs to define:
      - pipeline.ingest -> lorchestra job_id: "pipeline.ingest"
      - pipeline.canonize -> lorchestra job_id: "pipeline.canonize"
      - pipeline.formation -> lorchestra job_id: "pipeline.formation"
      - pipeline.project -> lorchestra job_id: "pipeline.project"
      - pipeline.views -> lorchestra job_id: "pipeline.views"
      - pipeline.run_all -> lorchestra job_id: "pipeline.daily_all" (note: divergent naming)
    commands:
      - "python -c \"import yaml; yaml.safe_load(open('src/life/jobs/pipeline.yaml'))\""
      - "life jobs list | grep pipeline"
    outputs:
      - "src/life/jobs/pipeline.yaml"

  - step_id: step-03
    description: "Create Pipeline Verb"
    role: implementer
    gate_ref: "G1: Code Review"
    prompt: |
      Create `src/life/commands/pipeline.py` with Typer subcommands.

      Commands to implement:
      - ingest: Run ingestion pipeline
      - canonize: Run canonization pipeline
      - formation: Run formation pipeline
      - project: Run local projection pipeline (with --full-refresh option)
      - views: Create BigQuery projection views
      - run_all: Run full daily pipeline

      Key implementation details:
      - Use `run_job()` to call life jobs
      - `run_job()` returns: {job_id, steps: [{name, result}]}
      - Pass `steps[0]["result"]` to `_print_result`
      - Get vault_path from config with ~ expansion
      - For project: clear views if --full-refresh, show vault statistics after
    commands:
      - "python -m life pipeline --help"
      - "python -m life pipeline ingest --help"
      - "python -m life pipeline project --help"
    outputs:
      - "src/life/commands/pipeline.py"

  - step_id: step-04
    description: "Register Verb and Test"
    role: implementer
    gate_ref: "G1: Integration Test"
    prompt: |
      1. Update `src/life/cli.py` to register pipeline verb:

      ```python
      from life.commands import pipeline
      app.add_typer(pipeline.app, name="pipeline")
      ```

      2. Test all subcommands in dry-run mode
    commands:
      - "python -m life --help"
      - "python -m life pipeline --help"
      - "python -m life --dry-run pipeline ingest"
      - "python -m life --dry-run pipeline project --full-refresh"
      - "python -m life --dry-run pipeline run-all"
    outputs:
      - "src/life/cli.py"

  - step_id: step-05
    description: "Write Tests"
    role: implementer
    gate_ref: "G2: Pre-Release"
    prompt: |
      Create `tests/test_pipeline.py` with comprehensive tests:

      Processor tests:
      - test_run_lorchestra_dry_run
      - test_run_lorchestra_success
      - test_run_lorchestra_failure
      - test_run_lorchestra_not_installed
      - test_clear_views_directory
      - test_clear_views_directory_dry_run
      - test_get_vault_statistics

      Verb -> job_id mapping tests (CRITICAL):
      - test_ingest_verb_calls_correct_job_id
      - test_canonize_verb_calls_correct_job_id
      - test_formation_verb_calls_correct_job_id
      - test_project_verb_calls_correct_job_id
      - test_views_verb_calls_correct_job_id
      - test_run_all_verb_calls_correct_job_id

      Integration tests:
      - test_project_full_refresh
      - test_project_shows_statistics
    commands:
      - "pytest tests/test_pipeline.py -v"
      - "pytest tests/test_pipeline.py --cov=src/life/commands/pipeline --cov=src/life_jobs/pipeline --cov-report=term-missing"
    outputs:
      - "tests/test_pipeline.py"

files_to_touch:
  - path: "src/life_jobs/pipeline.py"
    action: CREATE
  - path: "src/life/jobs/pipeline.yaml"
    action: CREATE
  - path: "src/life/commands/pipeline.py"
    action: CREATE
  - path: "src/life/cli.py"
    action: UPDATE
  - path: "tests/test_pipeline.py"
    action: CREATE

repo:
  working_branch: "feat/pipeline-verbs"
  merge_strategy: squash
